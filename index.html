<!doctype html> 
<html lang="en"> 
<head> 
  <meta charset="UTF-8" />
  <title>Dark Ages</title>
  <script type="text/javascript" src="phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

  <h1>Dark Ages</h1>
  <h3>Ansible Games Submission for Athens Game Jam 2014</h3>

  <div> 
    <ul>
        <li>Movement: Arrow Keys</li>
        <li>1/2/3: Set player illumination to unlit/partial/lit</li>
    </ul>
  </div>


<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update, render: render });

// phase content preload
function preload() {

  // dark ages
  game.load.image('player', 'assets/player.png');
  game.load.image('playerghost', 'assets/playerghost.png');
  game.load.image('background', 'assets/bg_environment.png');


    // phaser demo
    game.load.image('sky', 'assets/sky.png');
    game.load.image('ground', 'assets/platform.png');
    game.load.image('star', 'assets/star.png');
    game.load.image('diamond', 'assets/diamond.png');
    game.load.spritesheet('dude', 'assets/dude.png', 32, 48);

}

// game definitions

var player;
// blue debug circle showing light radius - could become a feature
var playerLightCircle = null;
// hack to clone player as a radial collision object
var playerLightRadius;
var platforms;
var cursors;
var keyboard;

var stars;

var litState = {
    UNLIT: 0,
    PARTIAL: 1,
    LIT: 2
};

// phaser game init
function create() {

    //  A simple background for our game
    game.add.sprite(0, 0, 'background');

    //  The platforms group contains the ground and the 2 ledges we can jump on
    platforms = game.add.group();

    // Here we create the ground.
    var ground = platforms.create(0, game.world.height - 64, 'ground');

    //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
    ground.scale.setTo(2, 2);

    //  This stops it from falling away when you jump on it
    ground.body.immovable = true;

    //  Now let's create two ledges
    var ledge = platforms.create(400, 400, 'ground');
    ledge.body.immovable = true;

    ledge = platforms.create(-150, 250, 'ground');
    ledge.body.immovable = true;

    // The player and its settings
    player = game.add.sprite(32, game.world.height - 150, 'player');

    //  Player physics properties. Give the little guy a slight bounce.
    player.body.bounce.y = 0.2;
    player.body.gravity.y = 1000;
    player.body.collideWorldBounds = true;

    //  Our two animations, walking left and right.
    //player.animations.add('left', [0, 1, 2, 3], 10, true);
    //player.animations.add('right', [5, 6, 7, 8], 10, true);

    //light init
    player.light = new LightObject(player, litState.LIT, 100, 'dude', 'dude', 'player');


    //  Finally some stars to collect
    stars = game.add.group();

    //  Here we'll create 12 of them evenly spaced apart
    for (var i = 0; i < 12; i++)
    {
        //  Create a star inside of the 'stars' group
        var star = stars.create(i * 70, 0, 'star');

        //  Let gravity do its thing
        star.body.gravity.y = 1000;

        //  This just gives each star a slightly random bounce value
        star.body.bounce.y = 0.7 + Math.random() * 0.2;

        // add light property
        star.light = new LightObject(star, litState.UNLIT, 0, 'star', 'star', 'diamond');
    }

    // player light radius sprite
    // hint - its the same sprite as player
    playerLightRadius = game.add.sprite(32, game.world.height - 150, 
        'playerghost');
    playerLightRadius.body.setCircle(player.light.getRadius());
    playerLightRadius.body.offset.x = player.body.width / 2;
    playerLightRadius.body.offset.y = player.body.height / 2;

    //  Our controls.
    cursors = game.input.keyboard.createCursorKeys();

    keyboard = game.input.keyboard;
    
}

// phaser game loop
function update() {

    // set all stars to unlit at start of tick
    stars.forEach(function(_star) {
        _star.light.setLighting(litState.UNLIT);
    }, this, true);

    //  Collide the player and the stars with the platforms
    game.physics.collide(player, platforms);
    game.physics.collide(stars, platforms);

    //  Checks to see if the player overlaps with any of the stars, if he does call the collectStar function
    game.physics.overlap(player, stars, collectStar, null, this);

    game.physics.overlap(playerLightRadius, stars, updateStarLighting, null, this);

    //  Reset the players velocity (movement)
    player.body.velocity.x = 0;

    if (cursors.left.isDown)
    {
        //  Move to the left
        player.body.velocity.x = -150;

        //player.animations.play('left');
    }
    else if (cursors.right.isDown)
    {
        //  Move to the right
        player.body.velocity.x = 150;

        //player.animations.play('right');
    }
    else
    {
        //  Stand still
        player.animations.stop();

        //player.frame = 4;
    }
    
    //  Allow the player to jump if they are touching the ground.
    if (cursors.up.isDown && player.body.touching.down)
    {
        player.body.velocity.y = -600;
    }

    //mod lighting of player -- testing only
    if (keyboard.isDown(Phaser.Keyboard.ONE))
    {
        player.light.setLighting(litState.UNLIT);
    }
    else if (keyboard.isDown(Phaser.Keyboard.TWO))
    {
        player.light.setLighting(litState.PARTIAL);
    }
    else if (keyboard.isDown(Phaser.Keyboard.THREE))
    {
        player.light.setLighting(litState.LIT);
    }

    // light radius follows player
    playerLightRadius.body.x = player.body.x;
    playerLightRadius.body.y = player.body.y;

}

function render () {
    // clear last tick's circle
    if(playerLightCircle != null)
    {
        playerLightCircle.destroy();
    }
    playerLightCircle = game.add.graphics(0, 0);  //init rect
    playerLightCircle.lineStyle(2, 0x0000FF, 1); // width, color (0x0000FF), alpha (0 -> 1) // required settings
    playerLightCircle.beginFill(0xFFFF0B, 0) // color (0xFFFF0B), alpha (0 -> 1) // required settings

    playerLightCircle.drawCircle(player.center.x, player.center.y, player.light.getRadius());
    playerLightCircle.endFill();
}

// from phaser demo
function collectStar (player, star) {
    
    // Removes the star from the screen only if player is lit
    if(player.light.getLighting() === litState.LIT)
    {
        star.kill();
    }

}

function updateStarLighting (_playerLightRadius, _star) {
    _star.light.setLighting(litState.LIT);
}

function LightObject(_owner, _litState, _radius, _unlitSprite, _partialSprite, _litSprite) {
    this.owner = _owner;
    this.lightSprites = [_unlitSprite, _partialSprite, _litSprite];
    this.setLighting(_litState);
    this.setRadius(_radius);
}

LightObject.prototype.owner = null;
LightObject.prototype.lightSprites = [];



// state of this object being lit
LightObject.prototype.lit = litState.UNLIT;

LightObject.prototype.setLighting = function(_litState) {
    if(this.lit != _litState) 
    {
        this.lit = _litState;
        this.updateSpriteBasedOnLighting();
    }
}

LightObject.prototype.getLighting = function() {
    return this.lit;
}

// how far away does thie entity light others
LightObject.prototype.radius = 0;

LightObject.prototype.setRadius = function(_radius) {
    this.radius = _radius;
}

LightObject.prototype.getRadius = function() {
    return this.radius;
}

LightObject.prototype.updateSpriteBasedOnLighting = function() {
    this.owner.loadTexture(this.lightSprites[this.getLighting()], 0);
}


</script>

</body>
</html>